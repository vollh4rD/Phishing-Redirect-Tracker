# Flask UTM Redirect Server for Microsoft Forms

## Overview

This project sets up a lightweight Flask-based web server that:
- Redirects incoming requests from a custom route (e.g., `https://domian.com/urgent-form`) to a destination URL.
- Captures UTM parameters (e.g., `utm_id`, `utm_source`) from the query string, supporting both underscore (`utm_id`) and hyphen (`utm-id`) formats.
- Logs full details (URL + all UTMs) to `utm_logs.txt` and simple timestamp + `utm_id` clicks to `utm_id_clicks.txt`.
- Includes a `tracker.py` script to match `utm_id` clicks against a user CSV (e.g., `user_list.csv` with columns: `name`, `email`, `utm_id`) and log tracked user details to `user_clicks_tracked.txt`.

**Key Features**:
- Configurable via `.env` (Form URL, route path, log dir).
- Deployed with Gunicorn (production WSGI) behind Nginx on Ubuntu VM.
- Supports subdomains (e.g., `subdomain.example.com`).
- Excludes SSL setup (add manually with Certbot).



## Prerequisites

- Ubuntu 24.04 LTS VM (e.g., Azure, AWS) with sudo access.
- Domain/subdomain with DNS control (A record to VM IP).

## Quick Start

1. **Prepare Files Locally**:
   - Clone this repo. 
   - Create `user_list.csv` (optional, for tracking):
     ```
     name,email,utm_id
     John Doe,john@example.com,abc123
     Jane Smith,jane@example.com,def456
     ```

2. **Run Setup on VM**:
   - Run: `chmod +x setup.sh && ./setup.sh`.
     - Inputs: Domain, subdomain (y/n), Form URL, route path, CSV filename.
   - DNS: Add A record for subdomain (or root) to VM IP.
   - Test: `curl http://localhost<route-path>?utm-id=test` (logs to `/var/log/redirect-app/`).

3. **Add SSL (Manual)**:
   - `sudo apt install certbot python3-certbot-nginx -y`.
   - `sudo certbot --nginx -d <subdomain>.<domain>`.
   - Open ports 80/443 in UFW and VM provider.

4. **Track Users**:
   - Place `user_list.csv` in `/var/www/redirect-app/`.
   - Run: `cd /var/www/redirect-app && source venv/bin/activate && python tracker.py`.
   - Output: Appends to `/var/log/redirect-app/user_clicks_tracked.txt`.

## Configuration

- **.env** (auto-generated by setup.sh, edit as needed):
  ```
  MS_FORM_URL=https://forms.office.com/r/your-form-id
  ROUTE_PATH=/user-migration-form
  LOG_DIR=/var/log/redirect-app
  ```
- Restart: `sudo systemctl restart redirect-app nginx`.

## Logs

- **utm_logs.txt**: Full redirects (e.g., "Redirecting from: <URL>", "UTM Parameters: {...}").
- **utm_id_clicks.txt**: Simple clicks (e.g., "2025-10-20T12:00:00: abc123").
- **user_clicks_tracked.txt**: Matched users (e.g., "2025-10-20T12:00:00: abc123 - John Doe (john@example.com)").
- View: `tail -f /var/log/redirect-app/utm_id_clicks.txt`.
- Nginx: `/var/log/nginx/redirect-app.access.log`.

## Usage

- **Redirect Example**: `https://evil.domain.com/user-migration-form?utm-id=abc123&utm_source=email`.
  - Redirects to Form with params preserved.
  - Logs `utm_id` if present.
- **Run Tracker**: Matches clicks to CSV users; runs new each time (appends to output log).
- **Test Locally**: `python redirect_server.py` (dev mode, port 5000).

## Scripts

- **setup.sh**: Automates install (venv, deps, services, configs). Run once.
- **cleanup.sh**: Removes everything (dirs, services, logs). Confirm with "CONFIRM".
- **Stop Temporarily**: `sudo systemctl stop redirect-app nginx`.

## Troubleshooting

- **Service Down**: `sudo systemctl status redirect-app` / `nginx`. Restart: `sudo systemctl restart <service>`.
- **No Logs**: Check perms (`sudo chown -R azureuser:azureuser /var/log/redirect-app`).
- **Nginx 502**: Socket missingâ€”`ls /var/www/redirect-app/redirect-app.sock`; restart Gunicorn.
- **UTM Not Captured**: Ensure `?utm-id=` or `?utm_id=` in URL.
- **Tracker Errors**: CSV headers must match (`name`, `email`, `utm_id`); run in venv.
- **DNS/SSL**: Wait propagation; test with `dig <subdomain>.<domain>`.

## Contributing/Extending

- Add DB logging: Replace file writes in `redirect_server.py` with SQLite/Postgres.
- Cron Tracker: Add to crontab: `0 * * * * cd /var/www/redirect-app && source venv/bin/activate && python tracker.py`.
- License: MIT (add if forking).

For issues, check `sudo journalctl -u redirect-app -f`. Built Oct 2025.